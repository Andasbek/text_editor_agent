# Архитектура Проекта

Этот документ описывает внутреннее устройство агента-редактора текста.

## Общий Обзор

Проект построен на базе **LangGraph** и реализует циклическую архитектуру для итеративного улучшения текста.
Основной принцип: **Writer -> Critic -> Editor**.

## Компоненты

### 1. Состояние Агента (`AgentState`)
Определено в `app/state.py`. Хранит контекст выполнения:
- `task`: Исходная задача пользователя.
- `draft`: Текущий текст.
- `critique`: Структурированная обратная связь.
- `iteration`: Счётчик итераций.
- `history`: История всех шагов для отчётности.

### 2. Граф (`app/graph.py`)
Определяет поток выполнения:
1. **Writer**: Генерирует первый черновик.
2. **Critic**: Оценивает черновик.
3. **Conditional Edge**:
    - Если `passed=True` И `iteration > 0`: Завершение.
    - Иначе: Переход к `Editor`.
    - *Особенность*: Даже если первый черновик идеален, граф принудительно выполняет одну итерацию Editor (проверка `iteration == 0`).
4. **Editor**: Исправляет текст и возвращает управление Critic.

### 3. Узлы (`app/nodes.py`)
- **writer_node**: Использует `WRITER_SYSTEM_PROMPT` или `WRITER_REVISE_PROMPT` в зависимости от режима.
- **critic_node**: Использует JSON-режим LLM для возврата объекта `ValidationResult` (см. `app/rubric.py`).
- **editor_node**: Принимает замечания (`issues`) и предложения (`suggestions`) для генерации новой версии.

## Диаграмма Потока

```mermaid
graph TD
    Start --> Writer
    Writer --> Critic
    Critic --> Check{Условие}
    Check -- "Не прошел ИЛИ 1-й круг" --> Editor
    Editor --> Critic
    Check -- "Прошел И итерация > 0" --> End
    Check -- "Макс итераций" --> End

### 4. Веб-Интерфейс (Smart Layer)
- **Service Layer** (`app/service.py`): Обертка над графом, преобразующая историю (`history`) в удобный для UI формат (`trace`).
- **Streamlit App** (`ui/streamlit_app.py`): Отрисовывает интерфейс, вызывает сервис и визуализирует шаги итераций.

```
