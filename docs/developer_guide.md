# Руководство Разработчика

Это руководство поможет вам понять, как расширять функционал агента.

## Структура Проекта

```
app/
├── main.py       # Точка входа CLI
├── graph.py      # Сборка графа LangGraph
├── nodes.py      # Логика узлов (Writer, Critic, Editor)
├── state.py      # Определение TypedDict состояния
├── prompts.py    # Текстовые промпты для LLM
├── rubric.py     # Pydantic схемы для валидации
├── report.py     # Логика сохранения отчетов
├── llm.py        # Инициализация LangChain ChatModel
└── service.py    # Сервисный слой для UI
ui/
└── streamlit_app.py # Интерфейс Streamlit
```

## Сервисный Слой

Для интеграции с UI используется `app.service.run_text_editor_agent`.
Эта функция запускает граф и форматирует историю выполнения в структурированный `trace`, удобный для отображения в frontend.

## Добавление Новых Критериев


Чтобы изменить критерии оценки текста:

1. Откройте `app/prompts.py`.
2. Отредактируйте `CRITIC_SYSTEM_PROMPT`. Добавьте новые пункты в список.
3. Если требуется изменение структуры ответа (например, новые поля), обновите класс `ValidationResult` в `app/rubric.py`.

## Изменение Логики Цикла

Логика перехода определяется функцией `verify_cycle` в `app/graph.py`.

**Пример: Увеличение обязательных итераций**
Измените условие:
```python
if iteration < 2:  # Заставит пройти минимум 2 круга
    return "editor"
```

## Тестирование

Для запуска тестов используйте `pytest`.
Тесты находятся в папке `tests/`.

```bash
# Запуск всех тестов
pytest tests/

# Запуск конкретного теста с выводом
pytest tests/test_min_one_cycle.py -v
```


### Структура Тестов

Проект использует `pytest` и моки для изоляции от внешних API.

- `tests/conftest.py`: Фикстуры для мокинга LLM (`mock_llm`, `mock_get_llm`).
- `tests/test_nodes.py`: Юнит-тесты отдельных узлов графа.
- `tests/test_service.py`: Тесты сервисного слоя и форматирования трассировки.
- `tests/test_integration.py`: Интеграционные тесты полного цикла с имитацией ответов LLM.
- `tests/test_min_one_cycle.py`: Проверка логики переходов графа.

При добавлении нового функционала, пожалуйста, добавляйте соответствующие тесты, используя фикстуру `mock_llm`.
